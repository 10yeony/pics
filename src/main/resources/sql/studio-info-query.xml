<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ================== 스튜디오 상세 페이지  ResultMap================== -->	
<mapper namespace="StudioInfoMapper">			
	<resultMap type="studio" id="studioInfoRM">							
		<result property="stuId" column="stu_id"/>			
		<result property="comId" column="com_id"/>
		<result property="categoryId" column="category_id"/>
		<result property="name" column="name"/>
		<result property="description" column="description"/>
		<result property="rule" column="rule"/>			
		<result property="mainImg" column="main_img"/>
		<result property="portImg" column="port_img"/>
		<result property="cadImg" column="cad_img"/>
		<result property="floor" column="floor"/>
		<association property="studioFilter" javaType="studioFilter">
			<id property="stuId" column="stu_id"/>
				<result property="filterId" column="filter_id" />
				<result property="size" column="size" />
				<result property="options" column="options"/>
				<result property="parking" column="parking"/>
				<result property="unitPrice" column="unit_price"/>
				<result property="defaultCapacity" column="default_capacity" />
				<result property="excharge" column="excharge"/>
				<result property="address" column="address" />
				<result property="maxCapacity" column="max_capacity"/>
		</association>
		<association property="company" javaType="company">
			<id property="comId" column="com_id" />
				<result property="comId" column="com_id"/>
				<result property="name" column="name"/>
				<result property="address" column="address"/>
				<result property="password" column="password"/>
				<result property="tel" column="tel" />
				<result property="description" column="description"/>
				<result property="logoImg" column="logo_img" />
		</association>
		<association property="category" javaType="category">
			<id property="categoryId" column="category_id"/>
				<result property="categoryId" column="category_id" />
				<result property="categoryName" column="category_name" />
		</association>	
	</resultMap>
 		
 	<resultMap type="review" id="reviewRM">
		<result property="reviewId" column="review_id" />
		<result property="score" column="score"/>
		<result property="content" column="content" />
		<result property="img" column="img"/>
		<result property="regDate" column="regDate"/>
		<result property="answer" column="answer" />
		<association property="customer" javaType="customer">
			<id property="custId" column="cust_id" />
			<result property="custId" column="cust_id"/>
			<result property="apiId" column="api_id"/>
			<result property="gender" column="gender"/>
			<result property="age" column="age"/>
			<result property="job" column="job" />
			<result property="funnel" column="funnel"/>
			<result property="email" column="email" />
			<result property="tel" column="tel" />
			<result property="apiKey" column="api_key" />
			<result property="imgSrc" column="img_src" />
		</association>
		<association property="studio" javaType="studio">
			<id property="stuId" column="stu_id" />
			<result property="stuId" column="stu_id"/>			
			<result property="comId" column="com_id"/>
			<result property="categoryId" column="category_id"/>
			<result property="name" column="name"/>
			<result property="description" column="description"/>
			<result property="rule" column="rule"/>			
			<result property="mainImg" column="main_img"/>
			<result property="portImg" column="port_img"/>
			<result property="cadImg" column="cad_img"/>
			<result property="floor" column="floor"/>
		</association>
 	</resultMap> 
 
	<select id="getStudioInfo" parameterType="int" resultMap="studioInfoRM">							
		SELECT 					
		s.stu_id,s.com_id,s.category_id,s.name,s.description,s.rule,s.main_img,s.port_img,s.cad_img,s.floor,
		ctg.category_id,ctg.category_name,
		com.name,com.logo_img,
		sf.filter_id,sf.size,sf.options,sf.parking,sf.unit_price,sf.default_capacity,sf.excharge,sf.address,sf.max_capacity
  		FROM studio s
		LEFT JOIN studio_category ctg ON s.category_id=ctg.category_id
		LEFT JOIN company com ON s.com_id=com.com_id
		LEFT JOIN studio_filter sf ON s.stu_id=sf.stu_id
 		<if test="'${value}'!=null">
		WHERE s.stu_id=${value};
		</if>
	</select>							

 	<select id="getStudioReviews" parameterType="int" resultMap="reviewRM">
		SELECT
		re.review_id,re.score, re.content, re.img, re.reg_date, re.answer,
		c.cust_id,c.api_id,c.gender,c.age,c.job,c.funnel,c.email,c.tel,c.api_key,c.img_src,
		s.stu_id,s.com_id,s.category_id,s.name,s.description,s.rule,s.main_img,s.port_img,s.cad_img,s.floor
		FROM review re 
		JOIN customer c ON re.cust_Id=c.cust_Id
		JOIN studio s ON re.stu_Id=s.stu_Id
		<if test="'${value}'!=null">
		WHERE re.stu_Id=${value}
		</if>
	</select>

	<select id="getAccCustomer" parameterType="int" resultType="int">							
		SELECT count(res.res_id)
		FROM reservation res
		GROUP BY res.stu_id
		HAVING res.stu_id=${value};
	</select>		
		
	<select id="getBookmark" parameterType="list" resultType="int">
		SELECT b.book_id,cust_id,stu_id
		FROM bookmark b
		WHERE b.cust_id = ${list[0]}
		AND b.stu_id = ${list[1]}
	</select>
		
 	<select id="getTags" parameterType="int" resultType="tag">							
		SELECT t.tag_id, t.stu_id ,t.tag_name
		FROM tag t
		<if test="'${value}'!=null">
		WHERE stu_id=${value}	
		</if>
	</select>		

	<select id="genderRatio" parameterType="int" resultType="customer">
		SELECT c.cust_id,c.gender
		FROM reservation res JOIN customer c ON c.cust_id=res.cust_id
		WHERE res.stu_id=${value}
		GROUP BY res.cust_id
	</select>
	

	<select id="ageRatio" parameterType="int" resultType="int">
		SELECT c.age-mod(c.age,10) ages ,count(distinct(c.cust_id)) cnt
		FROM reservation res JOIN customer c ON c.cust_id=res.cust_id
		WHERE res.stu_id=${value}
		GROUP BY ages
	</select>
	
	<!--  ================== 스튜디오 공간 등록 관련 쿼리 ========================  -->
	<insert id="registerStudioInfo" parameterType="studio">
		INSERT 
		INTO studio (com_id, category_id, name, description, rule, main_img, port_img, cad_img, floor) 
		VALUES(#{comId}, #{categoryId}, #{name}, #{description}, #{rule}, #{mainImg}, #{portImg}, #{cadImg}, #{floor});
	</insert>
	<insert id="registerTag" parameterType="tag">
		INSERT 
		INTO tag (stu_id, tag_name) 
		VALUES(#{stuId}, #{tagName});
	</insert>
	<select id="getStudioId" parameterType="studio" resultType="int">
		SELECT stu_id FROM studio WHERE name = #{name};
	</select>
	<select id="getCategory" resultType="category">
		SELECT category_id, category_name FROM studio_category; 	
	</select>						
 </mapper>	