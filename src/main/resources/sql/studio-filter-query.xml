<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="StudioFilterMapper">

	<!-- ================== 스튜디오 공간 등록 관련 쿼리 ======================= -->
	<insert id="registerStudioFilter" parameterType="studioFilter">
		INSERT INTO
		studio_filter(stu_id, size, options, parking, unit_price, default_capacity, excharge, address, max_capacity)
		VALUES (#{stdId}, #{size}, #{options}, #{parking}, #{unitPrice}, #{defaultCapacity}, #{excharge}, #{address}, #{maxCapacity})
	</insert>

	<select id="getStudioFilterId"></select>
	
	<!-- ============================제영스 공간 ======================================-->
	<!-- 필터 검색  결과를 위한 RM (Tag 제외) -->
	<resultMap type="studio" id="studioRM">
	<id column="stu_id" property="stdId"/>
	<result column="name" property="name"/>
	<result column="description" property="description"/>
	<result column="main_img" property="mainImg"/>
	<result column="avg" property="avgScore"/>
	<association property="category" javaType="category">
		<result column="category" property="categoryName"/>
	</association>
	<association property="studioFilter" javaType="studioFilter">
		<result column="unit_price" property="unitPrice"/>
	</association>
	</resultMap>
	
	<!-- 필터 검색  결과를 위한 쿼리 모듈 -->
	<sql id="Select-J-Studio-Category-filter-tag-review">
	SELECT
	s.stu_id, s.name, s.description, s.main_img,
	s.category,
	f.unit_price, f.tag,
	ifnull((r.score),0) avg
	FROM (
	SELECT
	s.stu_id, s.name, s.description, s.main_img, s.filter_id,
	c.category
	FROM studio s
	JOIN studio_category c
	ON s.category_id = c.category_id
	) s
	LEFT OUTER JOIN 
	(SELECT 
	f.unit_price, f.filter_id, t.tag
	FROM studio_filter f
	JOIN tag_dic t
	ON f.filter_id = t.filter_id) f
	ON f.filter_id = s.filter_id
	LEFT OUTER JOIN review r
	ON s.stu_id = r.stu_id
	
	</sql>
	
	<!-- 필터 검색 쿼리 -->
	<select id="selectByFilter" parameterType="studioFilter" resultMap="studioRM">
		<include refid="Select-J-Studio-Category-filter-tag-review"/>
		WHERE s.stu_id
		GROUP BY s.stu_id
	</select>
</mapper>